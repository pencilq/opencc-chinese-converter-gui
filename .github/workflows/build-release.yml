name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0, v1.1.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Test dependencies
      run: |
        echo "Testing Python and dependencies..."
        python --version
        pip list | findstr "opencc pandas openpyxl docx pyinstaller"
        echo "Testing imports..."
        python -c "import opencc; print('OpenCC import: OK')"
        python -c "import pandas; print('Pandas import: OK')"
        python -c "import openpyxl; print('OpenPyXL import: OK')"
        python -c "import docx; print('Python-docx import: OK')"
        echo "All dependencies verified successfully"
        
    - name: Build executable
      run: |
        echo "Starting PyInstaller build..."
        # ä½¿ç”¨ç®€åŒ–çš„ PyInstaller å‘½ä»¤è¿›è¡Œè°ƒè¯•
        pyinstaller --onefile --noconsole --name "OpenCCä¸­æ–‡è½¬æ¢å™¨" --add-data "sample_text.txt;." --add-data "sample_data.csv;." --add-data "README.md;." --add-data "LICENSE;." opencc-py-gui.py
        echo "Build completed, checking output..."
        dir dist
        if exist "dist\OpenCCä¸­æ–‡è½¬æ¢å™¨.exe" (
          echo "EXE file created successfully"
          dir /q "dist\OpenCCä¸­æ–‡è½¬æ¢å™¨.exe"
        ) else (
          echo "Simple build failed, trying with spec file..."
          pyinstaller --clean opencc-gui.spec
          dir dist
          if exist "dist\OpenCCä¸­æ–‡è½¬æ¢å™¨.exe" (
            echo "Spec file build succeeded"
          ) else (
            echo "ERROR: Both build methods failed!"
            echo "Contents of dist directory:"
            dir dist
            echo "Contents of build directory:"
            dir build
            exit 1
          )
        )
        
    - name: Create portable package
      run: |
        mkdir "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows"
        copy "dist\OpenCCä¸­æ–‡è½¬æ¢å™¨.exe" "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\"
        copy "README.md" "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\"
        copy "LICENSE" "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\"
        copy "sample_text.txt" "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\"
        copy "sample_data.csv" "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\"
        echo "OpenCC ä¸­æ–‡è½¬æ¢å™¨ - ä¾¿æºç‰ˆ" > "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "ä½¿ç”¨æ–¹æ³•ï¼š" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "1. åŒå‡» OpenCCä¸­æ–‡è½¬æ¢å™¨.exe å¯åŠ¨ç¨‹åº" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "2. é€‰æ‹©è¦è½¬æ¢çš„æ–‡ä»¶æˆ–ç›´æ¥è¾“å…¥æ–‡æœ¬" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "3. é…ç½®è½¬æ¢è®¾ç½®" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "4. ç‚¹å‡»è½¬æ¢æŒ‰é’®å¼€å§‹å¤„ç†" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "- Excelæ–‡ä»¶ (.xlsx, .xls)" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "- Wordæ–‡æ¡£ (.docx)" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        echo "- æ–‡æœ¬æ–‡ä»¶ (.txt)" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows\è¯´æ˜.txt"
        
    - name: Compress package
      run: |
        Compress-Archive -Path "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows" -DestinationPath "OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows-x64.zip"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-executable
        path: |
          dist/OpenCCä¸­æ–‡è½¬æ¢å™¨.exe
          OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows-x64.zip

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Test dependencies
      run: |
        echo "Testing Python and dependencies..."
        python --version
        pip list | grep -E "opencc|pandas|openpyxl|docx|pyinstaller"
        echo "Testing imports..."
        python -c "import opencc; print('OpenCC import: OK')"
        python -c "import pandas; print('Pandas import: OK')"
        python -c "import openpyxl; print('OpenPyXL import: OK')"
        python -c "import docx; print('Python-docx import: OK')"
        echo "All dependencies verified successfully"
        
    - name: Build executable
      run: |
        echo "Starting PyInstaller build..."
        # ä½¿ç”¨ç®€åŒ–çš„ PyInstaller å‘½ä»¤è¿›è¡Œè°ƒè¯•
        pyinstaller --onefile --noconsole --name "OpenCCä¸­æ–‡è½¬æ¢å™¨" --add-data "sample_text.txt:." --add-data "sample_data.csv:." --add-data "README.md:." --add-data "LICENSE:." opencc-py-gui.py
        echo "Build completed, checking output..."
        ls -la dist/
        if [ -f "dist/OpenCCä¸­æ–‡è½¬æ¢å™¨" ]; then
          echo "Executable created successfully"
          ls -lh "dist/OpenCCä¸­æ–‡è½¬æ¢å™¨"
        else
          echo "Simple build failed, trying with spec file..."
          pyinstaller --clean opencc-gui.spec
          ls -la dist/
          if [ -f "dist/OpenCCä¸­æ–‡è½¬æ¢å™¨" ]; then
            echo "Spec file build succeeded"
          else
            echo "ERROR: Both build methods failed!"
            echo "Contents of dist directory:"
            ls -la dist/
            echo "Contents of build directory:"
            ls -la build/
            exit 1
          fi
        fi
        
    - name: Create DMG package
      run: |
        mkdir "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS"
        cp "dist/OpenCCä¸­æ–‡è½¬æ¢å™¨" "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/"
        cp "README.md" "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/"
        cp "LICENSE" "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/"
        cp "sample_text.txt" "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/"
        cp "sample_data.csv" "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/"
        echo "OpenCC ä¸­æ–‡è½¬æ¢å™¨ - macOSç‰ˆ" > "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/è¯´æ˜.txt"
        echo "" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/è¯´æ˜.txt"
        echo "ä½¿ç”¨æ–¹æ³•ï¼š" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/è¯´æ˜.txt"
        echo "1. åŒå‡» OpenCCä¸­æ–‡è½¬æ¢å™¨ å¯åŠ¨ç¨‹åº" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/è¯´æ˜.txt"
        echo "2. å¦‚æœå‡ºç°å®‰å…¨æç¤ºï¼Œè¯·åœ¨ç³»ç»Ÿåå¥½è®¾ç½®-å®‰å…¨æ€§ä¸éšç§ä¸­å…è®¸è¿è¡Œ" >> "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS/è¯´æ˜.txt"
        tar -czf "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS-x64.tar.gz" "OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS"
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos-executable
        path: |
          dist/OpenCCä¸­æ–‡è½¬æ¢å™¨
          OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS-x64.tar.gz

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-executable
        path: ./windows-build/
        
    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: macos-executable
        path: ./macos-build/
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Read changelog
      id: changelog
      run: |
        if [ -f CHANGELOG.md ]; then
          # æå–å½“å‰ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—
          VERSION=${{ steps.get_version.outputs.VERSION }}
          awk "/## \[${VERSION#v}\]/{flag=1; next} /## \[/{flag=0} flag" CHANGELOG.md > current_changelog.txt || echo "## æ›´æ–°å†…å®¹" > current_changelog.txt
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          cat current_changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "CHANGELOG=## æ›´æ–°å†…å®¹" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: OpenCC ä¸­æ–‡è½¬æ¢å™¨ ${{ steps.get_version.outputs.VERSION }}
        body: |
          # OpenCC ä¸­æ–‡è½¬æ¢å™¨ ${{ steps.get_version.outputs.VERSION }}
          
          ## ğŸ“¥ ä¸‹è½½è¯´æ˜
          
          ### Windows ç”¨æˆ·
          - **æ¨è**: ä¸‹è½½ `OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows-x64.zip` (å®Œæ•´å®‰è£…åŒ…)
          - **æç®€ç‰ˆ**: ä¸‹è½½ `OpenCCä¸­æ–‡è½¬æ¢å™¨.exe` (ä»…å¯æ‰§è¡Œæ–‡ä»¶)
          
          ### macOS ç”¨æˆ·  
          - ä¸‹è½½ `OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS-x64.tar.gz`
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œæœªç­¾ååº”ç”¨
          
          ## âœ¨ ä¸»è¦åŠŸèƒ½
          
          - ğŸ”„ æ”¯æŒç®€ä½“/ç¹ä½“ä¸­æ–‡äº’è½¬
          - ğŸ“Š æ”¯æŒ Excelã€Wordã€æ–‡æœ¬æ–‡ä»¶æ‰¹é‡è½¬æ¢
          - ğŸ¯ Excel å¤šåˆ—é€‰æ‹©è½¬æ¢
          - ğŸ‘€ å®æ—¶é¢„è§ˆè½¬æ¢ç»“æœ
          - ğŸš€ å¿«é€Ÿç›´æ¥æ–‡æœ¬è½¬æ¢
          - ğŸ¨ æ¸…æ™°çš„ä¸¤æ å¼ç•Œé¢è®¾è®¡
          
          ## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          
          - **Windows**: Windows 10/11 (64ä½)
          - **macOS**: macOS 10.14+ (64ä½)
          - **å†…å­˜**: å»ºè®® 4GB ä»¥ä¸Š
          - **ç£ç›˜ç©ºé—´**: 100MB å¯ç”¨ç©ºé—´
          
          ## ğŸ› é—®é¢˜åé¦ˆ
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/pencilq/opencc-chinese-converter-gui/issues) ä¸­åé¦ˆã€‚
          
          ## ğŸ“ æ›´æ–°å†…å®¹
          
          ${{ steps.changelog.outputs.CHANGELOG }}
        draft: false
        prerelease: false
        files: |
          ./windows-build/OpenCCä¸­æ–‡è½¬æ¢å™¨.exe
          ./windows-build/OpenCCä¸­æ–‡è½¬æ¢å™¨-Windows-x64.zip
          ./macos-build/OpenCCä¸­æ–‡è½¬æ¢å™¨-macOS-x64.tar.gz
